name: Mobile Parallel Real Device Tests

on:
  push:
    branches: [main]

jobs:
  parallel-mobile-tests:
    runs-on: [self-hosted, macos, real-device]
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install Python dependencies
        run: poetry install

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Appium and drivers
        run: |
          npm install -g appium
          appium driver install uiautomator2
          appium driver install xcuitest

      - name: Start Appium server for Android
        run: nohup appium -p 4724 > appium-android.log 2>&1 &
      
      - name: Start Appium server for iOS
        run: nohup appium -p 4723 > appium-ios.log 2>&1 &

      - name: Wait for Appium servers to be ready
        run: |
          sleep 10
          nc -z localhost 4723
          nc -z localhost 4724

      - name: Run parallel mobile tests
        run: poetry run python tests/test_parallel_mobile.py

      - name: Upload Appium logs (optional)
        uses: actions/upload-artifact@v4
        with:
          name: appium-logs
          path: |
            appium-android.log
            appium-ios.log 